<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard - Upperfy</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;700&display=swap" rel="stylesheet">
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 400 400'%3E%3Cdefs%3E%3Cstyle%3E.cls-1%7Bfill:%23270949;%7D.cls-2%7Bfill:%23ff3d00;%7D.cls-3%7Bfill:%23fff;%7D%3C/style%3E%3C/defs%3E%3Cpath class='cls-1' d='M140,180 L140,120 Q140,50 200,50 L200,50 Q260,50 260,120 L260,180' stroke='%23270949' stroke-width='28' fill='none' stroke-linecap='round'/%3E%3Crect class='cls-2' x='100' y='170' width='200' height='180' rx='25'/%3E%3Ccircle class='cls-3' cx='200' cy='250' r='30'/%3E%3Crect class='cls-3' x='185' y='250' width='30' height='60' rx='8'/%3E%3C/svg%3E">

  <style>
    :root {
      --roxo-escuro: #270949;
      --roxo-medio: #87148C;
      --roxo-vivo: #4F1295;
      --laranja-vibrante: #FF3D00;
      --laranja-claro: #FF9200;
      --branco: #FFFFFF;
      --cinza: #dcdcdc;
      --cinza-escuro: #555;
      --bg-gradiente: linear-gradient(135deg, var(--roxo-escuro), var(--roxo-vivo), var(--roxo-medio));
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Montserrat', sans-serif;
      background: var(--bg-gradiente);
      background-size: 200% 200%;
      animation: gradientShift 20s ease infinite;
      color: var(--branco);
      margin: 0; padding: 0; min-height: 100vh;
      display: flex; flex-direction: column;
    }

    @keyframes gradientShift {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    header {
      display: flex; justify-content: space-between; align-items: center;
      padding: 1.5rem 2rem; background: rgba(0, 0, 0, 0.2); backdrop-filter: blur(10px);
    }

    .logo { display: flex; align-items: center; gap: 12px; }
    .logo img { width: 45px; height: 45px; }
    .brand { font-size: 1.6rem; font-weight: 700; color: var(--branco); }

    .header-right { display: flex; align-items: center; gap: 20px; }

    .user-menu {
      display: flex; align-items: center; gap: 12px;
      background: rgba(255, 255, 255, 0.1); padding: 8px 16px;
      border-radius: 25px; cursor: pointer; transition: all 0.3s;
    }
    .user-menu:hover { background: rgba(255, 255, 255, 0.2); }

    .user-avatar {
      width: 35px; height: 35px; border-radius: 50%;
      background: var(--laranja-vibrante); display: flex;
      align-items: center; justify-content: center;
      font-weight: 700; font-size: 16px; color: white;
    }

    .user-name { font-weight: 600; font-size: 14px; }

    .logout-btn {
      background: var(--laranja-vibrante); color: var(--branco);
      border: none; padding: 10px 24px; border-radius: 8px;
      cursor: pointer; font-weight: 600; font-size: 14px;
      transition: 0.3s; font-family: 'Montserrat', sans-serif;
    }
    .logout-btn:hover {
      background: var(--laranja-claro); transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(255, 61, 0, 0.4);
    }

    main {
      flex: 1; padding: 2.5rem 2rem;
      display: flex; flex-direction: column; align-items: center;
    }

    .welcome-section { width: 100%; max-width: 1400px; margin-bottom: 2rem; }
    .welcome-title { font-size: 2.2rem; font-weight: 700; margin-bottom: 0.5rem; }
    .welcome-subtitle { font-size: 1rem; opacity: 0.9; font-weight: 400; }

    .systems-title {
      font-size: 1.5rem; font-weight: 600; margin-bottom: 1.5rem;
      width: 100%; max-width: 1400px;
    }

    /* === BARRA DE PESQUISA E FILTROS === */
    .search-filter-bar {
      display: flex;
      gap: 1rem;
      width: 100%;
      max-width: 1400px;
      margin-bottom: 2rem;
      flex-wrap: wrap;
    }

    .search-input-wrapper {
      flex: 1;
      min-width: 250px;
      position: relative;
    }

    .search-input {
      width: 100%;
      padding: 14px 20px 14px 50px;
      border: 2px solid rgba(255, 255, 255, 0.2);
      border-radius: 10px;
      font-size: 15px;
      font-family: 'Montserrat', sans-serif;
      color: var(--branco);
      background: rgba(0, 0, 0, 0.3);
      backdrop-filter: blur(10px);
      transition: all 0.3s ease;
    }

    .search-input::placeholder {
      color: rgba(255, 255, 255, 0.6);
    }

    .search-input:focus {
      outline: none;
      border-color: var(--laranja-vibrante);
      background: rgba(0, 0, 0, 0.5);
    }

    .search-icon {
      position: absolute;
      left: 18px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 18px;
      opacity: 0.7;
    }

    .filter-btn {
      padding: 14px 24px;
      border: 2px solid rgba(255, 255, 255, 0.2);
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      font-family: 'Montserrat', sans-serif;
      color: var(--branco);
      background: rgba(0, 0, 0, 0.3);
      backdrop-filter: blur(10px);
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .filter-btn:hover {
      background: rgba(0, 0, 0, 0.5);
      border-color: rgba(255, 255, 255, 0.4);
    }

    .filter-btn.active {
      background: var(--laranja-vibrante);
      border-color: var(--laranja-vibrante);
    }

    .filter-btn.active:hover {
      background: var(--laranja-claro);
      border-color: var(--laranja-claro);
    }

    .grid {
      display: grid; 
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      gap: 2rem; 
      width: 100%; 
      max-width: 1400px;
    }

    /* === CARD ESTILO NETFLIX === */
    .card {
      position: relative;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 12px;
      overflow: hidden;
      cursor: pointer;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      backdrop-filter: blur(10px);
    }

    .card:hover {
      transform: scale(1.05);
      box-shadow: 0 16px 40px rgba(0, 0, 0, 0.5);
      z-index: 10;
    }

    .card-cover {
      width: 100%;
      aspect-ratio: 16 / 10;
      object-fit: cover;
      display: block;
      transition: filter 0.3s ease;
    }

    /* Card bloqueado - capa em preto e branco */
    .card.locked .card-cover {
      filter: grayscale(100%) brightness(0.6);
    }

    .card.locked:hover .card-cover {
      filter: grayscale(100%) brightness(0.7);
    }

    /* Badge de bloqueado */
    .card.locked::before {
      content: "üîí";
      position: absolute;
      top: 12px;
      right: 12px;
      font-size: 24px;
      background: rgba(0, 0, 0, 0.7);
      padding: 8px;
      border-radius: 50%;
      z-index: 5;
    }

    /* Overlay de informa√ß√µes */
    .card-info {
      padding: 20px;
      background: linear-gradient(to bottom, transparent 0%, rgba(0, 0, 0, 0.7) 30%, rgba(0, 0, 0, 0.95) 100%);
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      padding-top: 40px;
    }

    .card-title {
      font-size: 1.4rem;
      font-weight: 700;
      color: #fff;
      margin-bottom: 8px;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
    }

    .card-description {
      font-size: 0.9rem;
      color: rgba(255, 255, 255, 0.85);
      line-height: 1.5;
    }

    .card-description.truncated {
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .card-description.expanded {
      display: block;
      -webkit-line-clamp: unset;
    }

    .ver-mais-btn {
      background: none;
      border: none;
      color: var(--laranja-vibrante);
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
      padding: 0;
      margin-top: 8px;
      font-family: 'Montserrat', sans-serif;
      transition: color 0.2s;
      display: none;
    }

    .ver-mais-btn:hover {
      color: var(--laranja-claro);
      text-decoration: underline;
    }

    .ver-mais-btn.visible {
      display: inline-block;
    }

    /* Badge "Adquirir" para bloqueados */
    .card.locked .card-info::after {
      content: "Clique para adquirir";
      display: block;
      margin-top: 12px;
      padding: 8px 14px;
      background: var(--laranja-vibrante);
      color: white;
      font-size: 0.8rem;
      font-weight: 600;
      border-radius: 4px;
      text-align: center;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    /* === LOADING E ERRO === */
    .loading-container, .error-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 4rem 2rem;
      width: 100%;
      max-width: 1400px;
    }

    .loading-spinner {
      width: 50px;
      height: 50px;
      border: 4px solid rgba(255, 255, 255, 0.2);
      border-top-color: var(--laranja-vibrante);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .loading-text, .error-text {
      margin-top: 1rem;
      font-size: 1rem;
      opacity: 0.9;
    }

    .error-container {
      background: rgba(255, 61, 0, 0.1);
      border: 1px solid rgba(255, 61, 0, 0.3);
      border-radius: 12px;
    }

    .error-icon {
      font-size: 3rem;
      margin-bottom: 1rem;
    }

    .error-text {
      color: #ff6b6b;
      text-align: center;
    }

    .retry-btn {
      margin-top: 1rem;
      background: var(--laranja-vibrante);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      font-family: 'Montserrat', sans-serif;
      transition: 0.3s;
    }

    .retry-btn:hover {
      background: var(--laranja-claro);
      transform: translateY(-2px);
    }

    footer {
      text-align: center; padding: 1.5rem; font-size: 0.85rem;
      opacity: 0.7; background: rgba(0, 0, 0, 0.2);
    }

    @media (max-width: 768px) {
      header { flex-direction: column; gap: 15px; padding: 1rem; }
      .header-right { width: 100%; justify-content: space-between; }
      .welcome-title { font-size: 1.8rem; }
      .grid { grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1.5rem; }
    }

    @media (max-width: 480px) {
      .grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <header>
    <div class="logo">
      <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 400 400'%3E%3Cdefs%3E%3Cstyle%3E.cls-1%7Bfill:%23270949;%7D.cls-2%7Bfill:%23ff3d00;%7D.cls-3%7Bfill:%23fff;%7D%3C/style%3E%3C/defs%3E%3Cpath class='cls-1' d='M140,180 L140,120 Q140,50 200,50 L200,50 Q260,50 260,120 L260,180' stroke='%23270949' stroke-width='28' fill='none' stroke-linecap='round'/%3E%3Crect class='cls-2' x='100' y='170' width='200' height='180' rx='25'/%3E%3Ccircle class='cls-3' cx='200' cy='250' r='30'/%3E%3Crect class='cls-3' x='185' y='250' width='30' height='60' rx='8'/%3E%3C/svg%3E" alt="Upperfy Logo">
      <div class="brand">Upperfy</div>
    </div>
    <div class="header-right">
      <div class="user-menu">
        <div class="user-avatar" id="userAvatar">U</div>
        <span class="user-name" id="userName">Meu Perfil</span>
      </div>
      <button class="logout-btn" onclick="logout()">Sair</button>
    </div>
  </header>

  <main>
    <div class="welcome-section">
      <h1 class="welcome-title" id="welcomeTitle">Bem-vindo!</h1>
      <p class="welcome-subtitle" id="welcomeSubtitle">Acesse seus sistemas dispon√≠veis</p>
    </div>

    <h2 class="systems-title">Seus sistemas</h2>
    
    <!-- Barra de pesquisa e filtros -->
    <div class="search-filter-bar">
      <div class="search-input-wrapper">
        <span class="search-icon">üîç</span>
        <input type="text" class="search-input" id="searchInput" placeholder="Pesquisar por nome...">
      </div>
      <button class="filter-btn" id="filterAtivos" onclick="toggleFiltroAtivos()">
        <span>‚úì</span> S√≥ ativos
      </button>
    </div>
    
    <!-- Container din√¢mico dos cards -->
    <div id="sistemasContainer">
      <!-- Loading inicial -->
      <div class="loading-container" id="loadingState">
        <div class="loading-spinner"></div>
        <p class="loading-text">Carregando seus sistemas...</p>
      </div>
    </div>
  </main>

  <footer>
    ¬© 2025 Upperfy - Todos os direitos reservados
  </footer>

  <script>
    // ==========================================
    // 1. VERIFICA SE O USU√ÅRIO EST√Å LOGADO
    // ==========================================
    const autenticado = localStorage.getItem('autenticado');
    const idFuncionario = localStorage.getItem('id_funcionario');
    const usuarioNome = localStorage.getItem('usuario_nome');
    const empresaNome = localStorage.getItem('empresa_nome');

    // Vari√°veis para pesquisa e filtro
    let sistemasCarregados = [];
    let filtroAtivosAtivo = false;

    // Se n√£o tiver os dados, manda de volta para o login da Plataforma
    if (autenticado !== 'true' || !idFuncionario) {
      window.location.href = '../index.html';
    }

    // ==========================================
    // 2. PREENCHE DADOS DO USU√ÅRIO NA TELA
    // ==========================================
    window.addEventListener('DOMContentLoaded', () => {
      const welcomeTitle = document.getElementById('welcomeTitle');
      const welcomeSubtitle = document.getElementById('welcomeSubtitle');
      const userName = document.getElementById('userName');
      const userAvatar = document.getElementById('userAvatar');

      if (usuarioNome) {
        const primeiroNome = usuarioNome.split(' ')[0];
        welcomeTitle.textContent = `Bem-vindo, ${primeiroNome}!`;
        userName.textContent = primeiroNome;
        userAvatar.textContent = primeiroNome.charAt(0).toUpperCase();
      }

      if (empresaNome) {
        welcomeSubtitle.textContent = `${empresaNome} - Acesse seus sistemas dispon√≠veis`;
      }

      // Carrega os sistemas do n8n
      carregarSistemas();

      // Evento de pesquisa
      document.getElementById('searchInput').addEventListener('input', aplicarFiltros);
    });

    // ==========================================
    // 3. FUN√á√ÉO PARA CARREGAR SISTEMAS DO N8N
    // ==========================================
    async function carregarSistemas() {
      const container = document.getElementById('sistemasContainer');
      
      try {
        // Monta objeto com todo o localStorage
        const dadosLocalStorage = {};
        for (let i = 0; i < localStorage.length; i++) {
          const chave = localStorage.key(i);
          dadosLocalStorage[chave] = localStorage.getItem(chave);
        }

        // Faz a requisi√ß√£o POST para o n8n
        const response = await fetch('https://n8n.upperfy.com.br/webhook/b45a3be4-1f27-4b01-b341-dashplatupfy', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(dadosLocalStorage)
        });

        if (!response.ok) {
          throw new Error(`Erro HTTP: ${response.status}`);
        }

        const dados = await response.json();

        // Verifica se recebeu a lista de sistemas
        if (!dados.sistemas || !Array.isArray(dados.sistemas)) {
          throw new Error('Formato de resposta inv√°lido');
        }

        // Salva os sistemas na vari√°vel global
        sistemasCarregados = dados.sistemas;

        // Renderiza os cards
        renderizarCards(dados.sistemas);

      } catch (erro) {
        console.error('Erro ao carregar sistemas:', erro);
        mostrarErro(erro.message);
      }
    }

    // ==========================================
    // 4. FUN√á√ÉO PARA RENDERIZAR OS CARDS
    // ==========================================
    function renderizarCards(sistemas) {
      const container = document.getElementById('sistemasContainer');
      
      // Cria o grid
      const grid = document.createElement('div');
      grid.className = 'grid';

      sistemas.forEach((sistema, index) => {
        const card = document.createElement('div');
        card.className = `card ${sistema.bloqueado ? 'locked' : 'unlocked'}`;
        
        // Define a URL de destino baseado no status
        const urlDestino = sistema.bloqueado ? sistema.url_compra : sistema.url_acesso;
        
        // Adiciona evento de clique
        card.onclick = (e) => {
          // N√£o navega se clicou no bot√£o "Ver mais"
          if (e.target.classList.contains('ver-mais-btn')) return;
          acessarSistema(sistema);
        };

        // Monta o HTML do card
        card.innerHTML = `
          <img 
            class="card-cover" 
            src="${sistema.capa_url}" 
            alt="${sistema.nome}"
            onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 viewBox=%270 0 320 180%27%3E%3Crect fill=%27%23270949%27 width=%27320%27 height=%27180%27/%3E%3Ctext x=%2750%25%27 y=%2750%25%27 dominant-baseline=%27middle%27 text-anchor=%27middle%27 fill=%27%23FF3D00%27 font-family=%27Montserrat%27 font-size=%2724%27 font-weight=%27700%27%3E${sistema.nome}%3C/text%3E%3C/svg%3E'"
          >
          <div class="card-info">
            <h3 class="card-title">${sistema.nome}</h3>
            <p class="card-description truncated" id="desc-${index}">${sistema.descricao}</p>
            <button class="ver-mais-btn" id="btn-${index}" onclick="toggleDescricao(${index}, event)">Ver mais</button>
          </div>
        `;

        grid.appendChild(card);
      });

      // Substitui o loading pelo grid
      container.innerHTML = '';
      container.appendChild(grid);

      // Verifica quais descri√ß√µes precisam do bot√£o "Ver mais"
      setTimeout(() => {
        sistemas.forEach((sistema, index) => {
          verificarOverflow(index);
        });
      }, 100);
    }

    // ==========================================
    // 4.1. FUN√á√ÉO PARA VERIFICAR OVERFLOW
    // ==========================================
    function verificarOverflow(index) {
      const desc = document.getElementById(`desc-${index}`);
      const btn = document.getElementById(`btn-${index}`);
      
      if (desc && btn) {
        // Verifica se o texto est√° cortado
        if (desc.scrollHeight > desc.clientHeight) {
          btn.classList.add('visible');
        }
      }
    }

    // ==========================================
    // 4.2. FUN√á√ÉO PARA TOGGLE DA DESCRI√á√ÉO
    // ==========================================
    function toggleDescricao(index, event) {
      event.stopPropagation();
      
      const desc = document.getElementById(`desc-${index}`);
      const btn = document.getElementById(`btn-${index}`);
      
      if (desc.classList.contains('truncated')) {
        desc.classList.remove('truncated');
        desc.classList.add('expanded');
        btn.textContent = 'Ver menos';
      } else {
        desc.classList.remove('expanded');
        desc.classList.add('truncated');
        btn.textContent = 'Ver mais';
      }
    }

    // ==========================================
    // 4.3. FUN√á√ÉO PARA TOGGLE DO FILTRO ATIVOS
    // ==========================================
    function toggleFiltroAtivos() {
      filtroAtivosAtivo = !filtroAtivosAtivo;
      const btn = document.getElementById('filterAtivos');
      
      if (filtroAtivosAtivo) {
        btn.classList.add('active');
      } else {
        btn.classList.remove('active');
      }
      
      aplicarFiltros();
    }

    // ==========================================
    // 4.4. FUN√á√ÉO PARA APLICAR FILTROS
    // ==========================================
    function aplicarFiltros() {
      const termoPesquisa = document.getElementById('searchInput').value.toLowerCase().trim();
      
      let sistemasFiltrados = sistemasCarregados;
      
      // Filtro por nome
      if (termoPesquisa) {
        sistemasFiltrados = sistemasFiltrados.filter(sistema => 
          sistema.nome.toLowerCase().includes(termoPesquisa)
        );
      }
      
      // Filtro s√≥ ativos (n√£o bloqueados)
      if (filtroAtivosAtivo) {
        sistemasFiltrados = sistemasFiltrados.filter(sistema => !sistema.bloqueado);
      }
      
      renderizarCards(sistemasFiltrados);
    }

    // ==========================================
    // 5. FUN√á√ÉO PARA MOSTRAR ERRO
    // ==========================================
    function mostrarErro(mensagem) {
      const container = document.getElementById('sistemasContainer');
      
      container.innerHTML = `
        <div class="error-container">
          <div class="error-icon">‚ö†Ô∏è</div>
          <p class="error-text">N√£o foi poss√≠vel carregar os sistemas.<br><small>${mensagem}</small></p>
          <button class="retry-btn" onclick="carregarSistemas()">Tentar novamente</button>
        </div>
      `;
    }

    // ==========================================
    // 6. FUN√á√ÉO DE ACESSO AOS SISTEMAS (SSO)
    // ==========================================
    function acessarSistema(sistema) {
      // Se estiver bloqueado, vai para a p√°gina de compra
      if (sistema.bloqueado) {
        window.location.href = sistema.url_compra;
        return;
      }

      // Se usa SSO (como o Clockfy)
      if (sistema.usa_sso) {
        const rawUser = localStorage.getItem('usuario');
        
        if (!rawUser) {
          alert('Sess√£o inv√°lida. Fa√ßa login novamente.');
          logout();
          return;
        }

        // Codifica os dados do usu√°rio em Base64 para enviar na URL
        const token = btoa(rawUser);
        
        // Redireciona para o sistema levando o token
        window.location.href = `${sistema.url_acesso}?auth_data=${token}`;
        return;
      }

      // Para sistemas sem SSO, acesso direto
      window.location.href = sistema.url_acesso;
    }

    // ==========================================
    // 7. FUN√á√ÉO DE LOGOUT
    // ==========================================
    function logout() {
      if (confirm('Deseja realmente sair?')) {
        localStorage.clear();
        window.location.href = '../index.html';
      }
    }
  </script>
</body>
</html>
